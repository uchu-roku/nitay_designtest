# 市町村プルダウン修正（最終版）

## 問題の原因

1. **KEYCODEの構造の誤解**: 市町村コードはKEYCODEの**最初の2桁ではなく、3-4桁目**にある
2. **振興局コードと市町村コードの混同**: 振興局コードと市町村コードは別物
3. **データソースの確認不足**: 実際の市町村コードは「森林調査簿コード.xlsx」に記載されている

## KEYCODEの正しい構造

14桁のKEYCODEの構造：
```
01 01 0000 0001 0001
│  │  │    │    └─ その他（4桁）
│  │  │    └────── 小班（4桁）
│  │  └─────────── 林班（4桁）
│  └────────────── 市町村コード（2桁）★
└───────────────── 振興局コード（2桁）
```

例: `01010000010001`
- 振興局コード: `01` (渡島)
- 市町村コード: `01` (松前町)
- 林班: `0000`
- 小班: `0001`

## 解決策

### 1. 市町村コードマスターデータの正しい作成

`backend/extract_municipality_codes.py` を作成し、「森林調査簿コード.xlsx」から市町村コードを抽出：

実行方法：
```bash
cd backend
python extract_municipality_codes.py
```

生成されるファイル：
`backend/data/administrative/rinsyousigen/municipality_codes.json`

内容例：
```json
{
  "01": "松前町",
  "02": "福島町",
  "03": "知内町",
  "04": "木古内町",
  "05": "北斗市",
  "07": "七飯町",
  "13": "鹿部町",
  "15": "森町",
  "16": "八雲町",
  "17": "長万部町",
  "19": "函館市",
  ...
}
```

### 2. Map.jsxの修正

#### 市町村コード抽出ロジック（修正前）:
```javascript
// ❌ 間違い: 最初の2桁（振興局コード）を取得していた
const munCode = keycode.substring(0, 2)
```

#### 市町村コード抽出ロジック（修正後）:
```javascript
// ✅ 正しい: 3-4桁目（市町村コード）を取得
const munCode = keycode.substring(2, 4)
```

### 3. APIエンドポイント

`backend/main.py` に `/api/municipality-codes` エンドポイントを追加：
- 生成された `municipality_codes.json` を返す
- ファイルがない場合はデフォルトのマッピングを返す

### 4. フロントエンドの表示

プルダウンの表示形式：
```
すべて
01 - 松前町
02 - 福島町
03 - 知内町
...
19 - 函館市
```

## 市町村コードと振興局コードの違い

### 振興局コード（2桁）
北海道の14振興局：
- 01: 渡島
- 02: 檜山
- 03: 後志
- 04: 空知
- 05: 上川
- 06: 留萌
- 07: 宗谷
- 08: オホーツク
- 09: 胆振
- 10: 日高
- 11: 十勝
- 12: 釧路
- 13: 根室
- 14: 石狩

### 市町村コード（2桁）
各振興局内の市町村を識別：
- 01: 松前町（渡島振興局内）
- 02: 福島町（渡島振興局内）
- 19: 函館市（渡島振興局内）
- など

**重要**: 市町村コードは振興局ごとに独立しているため、同じ「01」でも振興局が違えば別の市町村を指す

## テスト方法

1. バックエンドを再起動:
   ```bash
   cd backend
   uvicorn main:app --reload
   ```

2. フロントエンドを再起動:
   ```bash
   cd frontend
   npm run dev
   ```

3. 森林簿レイヤーをONにする

4. 市町村プルダウンを確認:
   - 「すべて」
   - 「01 - 松前町」
   - 「02 - 福島町」
   - など、実際のデータに含まれる市町村が表示される

5. コンソールログを確認:
   - "市町村コードマスターデータ: {...}"
   - "データに存在する市町村コード: ['01', '02', '03', ...]"

## ファイル変更履歴

- `backend/extract_municipality_codes.py` (新規作成) - 市町村コード抽出スクリプト
- `backend/data/administrative/rinsyousigen/municipality_codes.json` (生成) - 市町村コードマスターデータ
- `backend/main.py` (修正) - APIエンドポイント追加
- `frontend/src/Map.jsx` (修正) - 市町村コード抽出ロジック修正（0-2桁 → 2-4桁）
- `frontend/src/App.jsx` (修正) - 市町村名マッピング追加、プルダウン表示改善

## 今後の改善案

1. **データの追加**:
   - 他の振興局のShapefileを追加すると、自動的にプルダウンに表示される

2. **振興局による絞り込み**:
   - 振興局を選択 → その振興局内の市町村のみ表示
   - 2段階の絞り込みが可能

3. **市町村名の詳細化**:
   - 振興局名も含めた表示: "01 - 松前町（渡島）"
