# 樹種コード98（天然林広葉樹）修正

## 問題

樹種コード98が表示されず、「天然林広葉樹」という日本語名が表示されていませんでした。

## 原因

コードマスタExcelの樹種セクションは**2列構成**になっており、右側の列（列25=コード、列30=名前）に97, 98, 99などの特殊コードが配置されていました。

### コードマスタの構造

| 行 | 列0（コード） | 列5（名前） | 列25（コード） | 列30（名前） |
|----|---------------|-------------|----------------|--------------|
| 53 | 01 | イチイ | 45 | ギンドロ |
| 54 | 02 | スギ | 46 | ヤマナラシ |
| ... | ... | ... | ... | ... |
| 80 | 41 | ヤナギ | 97 | その他人工林広葉樹 |
| 81 | 42 | セイヨウハコヤナギ | **98** | **天然林広葉樹** |
| 82 | 43 | エウロアメリカポプラ | 99 | 針広混交林 |

## 修正内容

`load_code_master()` 関数を修正して、**左側の列（列0+5）と右側の列（列25+30）の両方**から樹種コードを読み込むようにしました。

### 修正前

```python
# 左側の列のみ読み込み
for i in range(53, 84):
    code = df.iloc[i, 0]  # 列0
    name = df.iloc[i, 5]  # 列5
    # ...
```

### 修正後

```python
# 左側の列（列0+5）
for i in range(53, 84):
    code = df.iloc[i, 0]
    name = df.iloc[i, 5]
    # ...

# 右側の列（列25+30）を追加
for i in range(53, 84):
    if len(df.columns) > 30:
        code = df.iloc[i, 25]
        name = df.iloc[i, 30]
        # ...
```

## 確認結果

データ変換後、層索引JSONを確認：

```
樹種1コード: 98
樹種1名: 天然林広葉樹  ✅
```

### 読み込まれた樹種コード数

- **変更前**: 39件（0埋めあり/なし両対応）
- **変更後**: 69件（0埋めあり/なし両対応、左右両列）

### 追加された特殊コード

| コード | 名前 | 出現頻度 |
|--------|------|----------|
| 97 | その他人工林広葉樹 | - |
| 98 | 天然林広葉樹 | 33,528件（最多） |
| 99 | 針広混交林 | - |

## 動作確認

### 1. データ再変換完了

```
コードマスタを読み込み中...
  森林の種類コードを読み込み中...
  林種コードを読み込み中...
  樹種コードを読み込み中...
  ✓ 森林の種類: 23 件
  ✓ 林種: 6 件
  ✓ 樹種: 69 件（0埋めあり/なし両対応、左右両列）
```

### 2. ブラウザで確認

1. ブラウザをリロード（Ctrl+F5）
2. 森林簿ボタンをON
3. 樹種コード98の小班をクリック
4. ポップアップに「98 (天然林広葉樹)」と表示されることを確認

**期待される表示**:
```
層1 (複層区分: 1)
森林種類: 15 (防風保安林)
林種: 2 (天然林)
樹種: 98 (天然林広葉樹)  ← これが表示される
林齢: 71年
面積: 1.91 ha
```

## 樹種コードの出現頻度（上位10）

調査簿データでの使用状況：

| コード | 名前 | 件数 |
|--------|------|------|
| 98 | 天然林広葉樹 | 33,528 |
| 2 | スギ | 24,724 |
| 23 | トドマツ | 13,415 |
| 17 | カラマツ | 6,666 |
| （空白） | - | 3,606 |
| 26 | アカエゾマツ | 772 |
| 4 | クロマツ | 759 |
| 53 | ヤマハンノキ | 733 |
| 64 | ミズナラ | 514 |
| 54 | コバノヤマハンノキ | 420 |

## 未対応のコード

### 88（152件）

コードマスタに存在しないコードです。調査簿データでは人工林（林種コード1）で使用されています。

**対応方法**:
- コードマスタに88の定義がない場合は、コードのみ表示される
- 必要に応じて、コードマスタExcelに88の定義を追加

### 空白（3,606件）

樹種コードが空白の場合は「N/A」と表示されます。

## 技術的な詳細

### 列番号の確認

Excelファイルは47列あり、樹種コードは以下の2箇所に配置されています：

- **左側**: 列0（コード）、列5（名前）
- **右側**: 列25（コード）、列30（名前）

### エラーハンドリング

コード値が数値でない場合（例: "空欄"）は、`try-except` でスキップします。

```python
try:
    code_no_zero = str(int(float(code_str)))
    code_masters['樹種'][code_no_zero] = name_str
except:
    pass  # 数値でない場合はスキップ
```

## 関連ファイル

- `backend/convert_forest_registry_to_geojson.py` - 修正したスクリプト
- `backend/data/administrative/rinsyousigen/森林調査簿コード.xlsx` - コードマスタ
- `backend/data/administrative/rinsyousigen/layers_index.json` - 更新された層索引（102.64 MB）
