# Nitay

## 概要
地図上で範囲を指定し、森林の木の本数と材積を推定するアプリケーション

**デモサイト**: https://uchu-roku.github.io/nitay_designtest/

## 機能
### A. 自由範囲指定モード
- 地図上での矩形・ポリゴン範囲指定
- GeoTIFFファイルのアップロード
- 樹木検出（DeepForest使用）
- 本数・材積の概算表示

### B. 画像持込モード
- GeoTIFF（座標付き）のアップロード
- 範囲指定後、Aと同じパイプラインで解析

### C. 森林簿ベースモード（林班・小班起点）
- 森林計画図の林班・小班ポリゴンをクリックして解析対象を選択
- 森林簿データ（樹種・樹齢・面積・材積など）との比較表示
- 2つのサブモード：
  - **aパターン**: 林班・小班をそのまま解析
  - **bパターン**: 林班・小班の内部で範囲を切り出して解析

## セットアップ

### ローカル開発

#### バックエンド
```bash
cd backend
pip install -r requirements.txt
python main.py
```

#### フロントエンド
```bash
cd frontend
npm install
npm run dev
```

### デプロイ

**クイックスタート**: `QUICKSTART.md`を参照

**詳細手順**: `SETUP_GITHUB.md`を参照

**トラブルシューティング**: `DEPLOYMENT.md`を参照

#### 重要な設定

1. **フロントエンド環境変数**（Vercel）:
   ```
   VITE_API_URL=https://your-backend-url.onrender.com
   ```

2. **データファイル管理**:
   - Git LFSを使用（推奨）
   - または外部ストレージからダウンロード

3. **バックエンドコマンド**（Render）:
   ```
   Build: pip install -r backend/requirements.txt
   Start: cd backend && uvicorn main:app --host 0.0.0.0 --port $PORT
   ```

## 技術スタック
- Backend: FastAPI (Python)
- Frontend: React + Leaflet
- 樹木検出: DeepForest
- 画像処理: rasterio, GDAL

## 森林簿ベースモードの詳細

### C-1. 基本コンセプト
- 森林計画図の林班・小班ポリゴンをクリックすると、その範囲を解析対象として扱う
- 森林簿はベース情報・比較対象としてマップ上に重ねて表示
- 実測に近い値（画像解析結果）との差分を把握しやすくする
- 個体木検出・材積推定の処理フローは、フロントエンドAの③以降と共通

### C-2. 利用パターン

#### (1) aパターン：林班・小班をそのまま解析するモード
**ユーザー操作**
1. 地図上で「森林計画図レイヤ（林班・小班）」を表示
2. 対象とする林班・小班ポリゴンをクリック
3. 「この小班をまるごと解析」ボタンを押す

**バックエンド側の挙動**
- クリックされた林班・小班ポリゴンをAOI（関心領域）として採用
- 以降はフロントエンドAの③以降と同じパイプラインで処理
  - 対応する高解像GeoTIFFを取得（または既存画像を再利用）
  - GeoTIFF前処理 → TreeEyed / DeepForestで個体木検出
  - ポリゴン内の点を集計して、本数・材積を算出（ポイント in ポリゴン）
- 出力画面では、
  - 小班単位の森林簿データ（既存の面積・材積など）と、
  - アプリ推定値（本数・材積）を並べて表示し、差分を確認できるようにする

#### (2) bパターン：林班・小班の内部でユーザーが範囲を切り出すモード
**ユーザー操作**
1. aパターン同様に、対象林班・小班をクリック
2. 「この小班の一部だけを解析」モードを選択
3. 小班ポリゴンの内部で、矩形または任意ポリゴンを描いて解析範囲を指定

**バックエンド側の挙動**
- 「林班・小班 × ユーザー指定ポリゴン」の交差部分をAOIとして採用
- それ以降はフロントエンドAの③以降と同じパイプラインで処理
- 出力では、
  - ユーザー指定範囲の本数・材積推定値に加え、
  - その範囲が属する林班・小班全体の森林簿データも参考情報として表示
  - 「小班全体のうち、どの程度の面積・材積をカバーしているか」を示す（例：小班面積に対する比率など）

### C-3. 森林簿データの扱い（共通仕様）

**マップ上での表示**
- 林班・小班境界のポリゴンレイヤ
- 森林簿由来の属性（林班番号・小班番号・樹種・樹齢・面積・森林簿材積・地位級など）をポップアップやサイドパネルで表示

**アプリ側での利用方針**
- 画像解析結果の比較対象・検証用として使う
- 森林簿そのものは所有者情報等を含みがちなため、
  - 表示する項目は「材積・樹種・樹齢・面積などの資源情報」に限定
  - 個人情報に関わる属性は非表示または取得しない設計とする

**解析パイプラインとの関係**
- AOIの決定ロジックに森林簿ポリゴンを利用するが、
- 個体木検出〜材積積算のアルゴリズム自体はA/Bのケースと完全共通とし、
- 「森林簿ベースモード」を追加しても、モデル実装や解析コードの分岐を増やさない設計とする

### C-4. 初心者向けの説明
「森林簿という"森林の台帳"で区切られた区画（林班・小班）を地図上に表示しておき、その区画をクリックすると、その範囲の木の本数や材積を画像から推定します。さらに、その中の一部だけを囲んで詳しく見ることもできます。台帳に書かれている材積と、画像からの推定結果を並べて見ることで、『どの小班が実態とズレていそうか』を効率的に洗い出す、というイメージです。」

## 注意事項
- MVP版のため、GeoTIFF持込解析のみ対応
- 画像自動調達機能は未実装
- 森林簿ベースモード（Cパート）は今後実装予定
