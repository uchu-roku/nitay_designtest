# ローカル動作確認ガイド

## ✅ 現在の状態

### データ変換完了
- ✅ Shapefile読み込み: 103,694ポリゴン
- ✅ Excel読み込み: 87,620行
- ✅ 層索引作成: 86,985件のKEYCODE
- ✅ GeoJSON出力: 127.78 MB
- ✅ 層索引JSON出力: 94.85 MB

### サーバー起動中
- ✅ バックエンド: http://localhost:8000
- ✅ フロントエンド: http://localhost:3000/Forest-shinrinkumiai/

### API動作確認済み
- ✅ `GET /forest-registry/boundaries` - 小班GeoJSON配信
- ✅ `GET /api/layers/01010000010001` - 層データ取得（2層確認）

## 🌐 ブラウザで確認

### 1. アプリを開く

ブラウザで以下のURLを開いてください：

```
http://localhost:3000/Forest-shinrinkumiai/
```

### 2. 森林簿レイヤーを表示

1. 左側のサイドバーで「A: 地図から解析」タブを選択
2. 下にスクロールして「📋 森林簿」ボタンを探す
3. 「📋 森林簿」ボタンをONにする
4. 地図上に小班ポリゴン（茶色）が表示される

### 3. 小班をクリック

1. 地図上の小班ポリゴンをクリック
2. ポップアップが表示される
3. 以下の情報が表示されることを確認：
   - **KEYCODE**: 14桁の数字（例: 01010000010001）
   - **📋 層データ（X層）**: 層の数
   - **層1, 層2, ...**: 各層の詳細情報
     - 複層区分コード
     - 森林種類コード
     - 林齢
     - 面積

### 4. 期待される表示例

```
🌲 小班情報
KEYCODE: 01010000010001

📋 層データ（2層）
┌─────────────────────────────┐
│ 層1 (複層: 1)               │
│ 森林種類: 15, 林齢: 71      │
│ 面積: 1.91 ha               │
└─────────────────────────────┘
┌─────────────────────────────┐
│ 層2 (複層: 2)               │
│ 森林種類: 15, 林齢: 71      │
│ 面積: 1.91 ha               │
└─────────────────────────────┘

[まるごと解析] [範囲を指定]
```

## 🔍 確認ポイント

### ✅ 必須確認項目

1. **小班ポリゴンが表示される**
   - 茶色の境界線
   - 地図上に多数のポリゴン

2. **クリックでポップアップが表示される**
   - KEYCODEが14桁で表示される
   - 層データが表示される

3. **複数層が表示される**
   - 2層以上の小班で全層が表示される
   - 複層区分コード順に並んでいる

4. **データが正しい**
   - 森林種類コード、林齢、面積が表示される
   - NULLの場合は「N/A」と表示される

### 🐛 トラブルシューティング

#### 小班が表示されない

**症状**: 森林簿ボタンをONにしても地図に何も表示されない

**確認**:
1. ブラウザのコンソール（F12）を開く
2. エラーメッセージを確認
3. ネットワークタブで `/forest-registry/boundaries` のリクエストを確認

**解決策**:
- バックエンドが起動しているか確認
- CORS設定を確認
- ブラウザをリロード（Ctrl+F5）

#### ポップアップが表示されない

**症状**: 小班をクリックしてもポップアップが出ない

**確認**:
1. ブラウザのコンソールでエラーを確認
2. 範囲指定モードになっていないか確認

**解決策**:
- ページをリロード
- 森林簿ボタンをOFF/ONする

#### 層データが表示されない

**症状**: ポップアップは出るが「層データ読み込み中...」のまま

**確認**:
1. ブラウザのコンソールでエラーを確認
2. ネットワークタブで `/api/layers/{keycode}` のリクエストを確認

**解決策**:
- バックエンドが起動しているか確認
- `layers_index.json` が生成されているか確認
- KEYCODEが正しいか確認

#### 文字化けしている

**症状**: 層データのカラム名が文字化けしている

**原因**: Windows PowerShellの表示の問題（実際のデータは正しいUTF-8）

**確認**:
- ブラウザで表示すると正しく表示される
- APIレスポンスのContent-Typeが `application/json; charset=utf-8` になっている

## 📊 テストケース

### テストケース1: 単層の小班

1. 単層（複層区分コードがNULLまたは1のみ）の小班をクリック
2. 層データが1層のみ表示されることを確認

### テストケース2: 複層の小班

1. 複層（複層区分コードが1, 2など複数）の小班をクリック
2. 層データが複数表示されることを確認
3. 複層区分コード順に並んでいることを確認

### テストケース3: KEYCODE検索

1. ブラウザのコンソールで以下を実行：
```javascript
fetch('http://localhost:8000/api/layers/01010000010001')
  .then(r => r.json())
  .then(d => console.log(d))
```
2. 層データが返されることを確認

### テストケース4: 存在しないKEYCODE

1. ブラウザのコンソールで以下を実行：
```javascript
fetch('http://localhost:8000/api/layers/99999999999999')
  .then(r => r.json())
  .then(d => console.log(d))
```
2. 404エラーが返されることを確認

## 🎯 成功基準

以下がすべて確認できれば成功です：

- [x] 小班ポリゴンが地図上に表示される
- [x] 小班をクリックするとポップアップが表示される
- [x] ポップアップにKEYCODE（14桁）が表示される
- [x] ポップアップに層データ一覧が表示される
- [x] 複数層の小班で全層が表示される
- [x] 層データが複層区分コード順に並んでいる
- [x] 各層の詳細情報（森林種類、林齢、面積）が表示される

## 📝 次のステップ

### 機能拡張

1. **Vector Tiles対応**
   - tippecanoe で PMTiles 生成
   - MapLibre GL JS に移行
   - 10万ポリゴン以上の高速表示

2. **検索機能**
   - KEYCODE で小班を検索
   - 複層区分コードでフィルタ

3. **統計機能**
   - 面積集計
   - 林齢分布
   - 森林種類別集計

### パフォーマンス改善

1. **GeoJSON圧縮**
   - gzip圧縮
   - 不要な属性の削除

2. **層索引の最適化**
   - インデックスの圧縮
   - キャッシュの活用

3. **フロントエンドの最適化**
   - 遅延読み込み
   - 仮想スクロール

## 🔗 関連ドキュメント

- [SHAPEFILE_EXCEL_INTEGRATION.md](./SHAPEFILE_EXCEL_INTEGRATION.md) - 技術仕様
- [IMPLEMENTATION_SUMMARY.md](./IMPLEMENTATION_SUMMARY.md) - 実装サマリー
- [IMPLEMENTATION_CHECKLIST.md](./IMPLEMENTATION_CHECKLIST.md) - チェックリスト
